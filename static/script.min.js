"use strict";!function(){var t=function(e,t,n){return e=Math.min(e,n),e=Math.max(e,t)};window.utils={isEsc:function(e){return 27===e.keyCode},boundNumber:t,bound0to100:function(e){return t(e,0,100)},hasDuplicates:function(n){return(n=n.slice(0).sort()).some(function(e,t){return!!t&&n[t]===n[t-1]})},isValidHashTag:function(e){return/^#([a-zA-Zа-яА-Я]+-)*([a-zA-Zа-яА-Я])+$/.test(e)},splitComma:function(e){return e.split(/[\s,]+/)},appendNodes:function(e,t){var n=document.createDocumentFragment();e.forEach(function(e){n.appendChild(e)}),t.appendChild(n)},shuffle:function(e){var t=e.slice(0);return t.sort(function(){return Math.random()-.5}),t},sortByProperty:function(e,n){return(e=e.slice(0)).sort(function(e,t){return t[n]-e[n]}),e},sortByPropertyLength:function(e,n){return(e=e.slice(0)).sort(function(e,t){return t[n].length-e[n].length}),e},toLowerCaseList:function(e){return e.map(function(e){return e.toLowerCase()})},isFileTypeOfImage:function(e){return"image"===e.slice(0,5)}}}(),function(){var t=document.querySelector(".modal-error"),n=t.querySelector(".modal-error__message"),o=t.querySelector(".modal-error__close"),r=function(){e()},e=function(){t.classList.add("hidden"),o.removeEventListener("click",r)};window.modalError={show:function(e){n.textContent=e,t.classList.remove("hidden"),o.addEventListener("click",r)},hide:e}}(),function(){var o=window.SERVER_URL_GET,r=window.SERVER_URL_POST,i=function(e,t){var r,i,n,o,u=new XMLHttpRequest;return u.responseType="json",u.timeout=1e4,u.addEventListener("load",(r=e,i=t,function(e){var t,n,o=e.target;200===o.status?r(o.response):i((t=o.status,n=o.statusText,"Cтатус ответа: "+t+" "+n))})),u.addEventListener("error",(n=t,function(){n("Произошла ошибка соединения")})),u.addEventListener("timeout",(o=t,function(e){var t=e.target;o("Запрос не успел выполниться за "+t.timeout+"мс")})),u};window.backend={load:function(e,t){var n=i(e,t);n.open("GET",o),n.send()},upload:function(e,t,n){var o=i(t,n);o.open("POST",r),o.send(e)}}}(),function(){var n=document.querySelector(".pictures"),c=document.querySelector("#picture-template").content.querySelector(".picture"),o=function(e){var u,t=(u=[],e.forEach(function(e,t){var n,o,r,i=(n=e,o=t,(r=c.cloneNode(!0)).querySelector("img").src=n.url,r.querySelector("img").dataset.index=o,r.querySelector(".picture-likes").textContent=n.likes,r.querySelector(".picture-comments").textContent=n.comments.length,r);u.push(i)}),u);n.textContent="",window.utils.appendNodes(t,n),window.pictures=e};window.data={sortByLikes:function(e){return window.utils.sortByProperty(e,"likes")},sortByComments:function(e){return window.utils.sortByPropertyLength(e,"comments")},updatePictures:o},window.backend.load(function(e){var t=e.data;window.picturesAll=t,o(t),window.filters.show()},window.modalError.show)}(),function(){var n=document.querySelector(".gallery-overlay"),o=n.querySelector(".gallery-overlay-close"),t=function(){n.classList.add("hidden"),o.removeEventListener("click",r),document.removeEventListener("keydown",i)},r=function(e){e.preventDefault(),e.stopPropagation(),t()},i=function(e){window.utils.isEsc(e)&&t()};window.preview={show:function(e){var t;t=window.pictures[e],n.querySelector("img").src=t.url,n.querySelector(".likes-count").textContent=t.likes,n.querySelector(".comments-count").textContent=t.comments.length,n.classList.remove("hidden"),o.addEventListener("click",r),document.addEventListener("keydown",i)}}}(),function(){var e=document.querySelector(".container"),u=function(e){return e.classList.contains("picture")};e.addEventListener("click",function(e){var t,n,o=e.target;if(e.preventDefault(),(n=o).parentNode&&u(n.parentNode)||u(o)){var r="IMG"===(t=o).tagName?t:t.children[0],i=r.dataset.index;window.preview.show(i)}})}(),function(){var e=document.querySelector(".upload-form"),n=e.querySelector(".upload-form-hashtags"),o=e.querySelector(".upload-form-description"),t=e.querySelector("#upload-submit"),r=function(e){return e=e.toLowerCase(),window.utils.isValidHashTag(e)?!(20<e.length)||(n.setCustomValidity("Хеш-тег имеет длину более 20 символов"),!1):(n.setCustomValidity("Хеш-тег должен иметь вид #турция-пляж"),!1)},i=function(e,t){e?n.classList.remove("invalid"):n.classList.add("invalid"),t?o.classList.remove("invalid"):o.classList.add("invalid")},u=function(){var e=function(){var e=n.value.trim();if(e){var t=window.utils.splitComma(e);if(!(t=window.utils.toLowerCaseList(t)).every(r))return!1;if(5<t.length)return n.setCustomValidity("Не более 5 хеш-тегов"),!1;if(window.utils.hasDuplicates(t))return n.setCustomValidity("Хеш-теги повторяются"),!1}return n.setCustomValidity(""),!0}(),t=140<o.value.trim().length?(o.setCustomValidity("Не более 140 символов"),!1):(o.setCustomValidity(""),!0);i(e,t)};window.formValidation={beginValidation:function(){t.addEventListener("click",u)},stopValidation:function(){t.removeEventListener("click",u),i(!0,!0)}}}(),function(){var o=document.querySelector(".upload-form"),r=o.querySelector(".upload-input"),t=document.querySelector(".effect-image-preview"),i=o.querySelector(".upload-overlay"),u=o.querySelector("#upload-cancel"),c=o.querySelector(".effect-image-preview"),n=o.querySelector(".upload-resize-controls-value"),s=o.querySelector(".upload-resize-controls-button-inc"),a=o.querySelector(".upload-resize-controls-button-dec"),e=o.querySelector(".upload-effect-level"),d=o.querySelector(".upload-effect-level-value"),l=o.querySelector(".upload-effect-level"),f=o.querySelector(".upload-effect-level-line"),m=o.querySelector(".upload-effect-level-val"),w=o.querySelector(".upload-effect-level-pin"),v=o.querySelector(".upload-form-description"),p=o.querySelector(".upload-effect-controls"),y=new FileReader,L=function(){var e=parseInt(n.value,10)/100;c.style.transform="scale("+e+")"},h=function(){return parseInt(n.value,10)},E=function(e){n.value=window.utils.boundNumber(e,25,100)+"%"},S=function(){var e,t=o.elements.effect.value,n=d.value;switch(t){case"none":c.style.filter="";break;case"chrome":e=n/100,c.style.filter="grayscale("+e+")";break;case"sepia":e=n/100,c.style.filter="sepia("+e+")";break;case"marvin":e=n,c.style.filter="invert("+e+"%)";break;case"phobos":e=n/100*3,c.style.filter="blur("+e+"px)";break;case"heat":e=n/100*3,c.style.filter="brightness("+e+")"}"none"!==t?k():b()},g=function(){i.classList.add("hidden"),window.formValidation.stopValidation(),o.reset(),L(),S(),s.removeEventListener("click",T),a.removeEventListener("click",P),u.removeEventListener("click",x),document.removeEventListener("keydown",R),p.removeEventListener("change",B),o.removeEventListener("submit",z),w.removeEventListener("keydown",N),y.removeEventListener("load",F)},q=function(e){var t=f.getBoundingClientRect(),n=(e-t.x)/t.width*100;return window.utils.bound0to100(n)},k=function(){e.classList.remove("hidden"),w.addEventListener("mousedown",D),l.addEventListener("click",M)},b=function(){e.classList.add("hidden"),w.removeEventListener("mousedown",D),l.removeEventListener("click",M)},C=function(){return d.value},V=function(e){var t;e=window.utils.bound0to100(Math.round(e)),m.style.width=e+"%",w.style.left=e+"%",t=e,d.value=t,S()},T=function(){E(h()+25),L()},P=function(){E(h()-25),L()},x=function(){g()},R=function(e){window.utils.isEsc(e)&&document.activeElement!==v&&g()},B=function(){V(100)},D=function(e){e.preventDefault(),e.stopPropagation(),document.addEventListener("mousemove",_),document.addEventListener("mouseup",A)},A=function(e){V(q(e.clientX)),document.removeEventListener("mousemove",_),document.removeEventListener("mouseup",A)},N=function(e){switch(e.keyCode){case 37:V(+C()-10);break;case 39:V(+C()+10)}},_=function(e){V(q(e.clientX))},M=function(e){_(e)},z=function(e){e.preventDefault(),window.backend.upload(new FormData(o),g,window.modalError.show)},F=function(e){t.src=e.target.result};r.addEventListener("change",function(){var e,t=r.files[0],n=t.type;window.utils.isFileTypeOfImage(n)?(i.classList.remove("hidden"),window.formValidation.beginValidation(),s.addEventListener("click",T),a.addEventListener("click",P),u.addEventListener("click",x),document.addEventListener("keydown",R),p.addEventListener("change",B),o.addEventListener("submit",z),w.addEventListener("keydown",N),y.addEventListener("load",F),e=t,y.readAsDataURL(e)):window.modalError.show("Файл не является изображением")})}(),window.debounce={createTimerKeeper:function(){return{id:null}},addListener:function(e,t,n,o){e.addEventListener(t,function(e){null!==o.id&&clearTimeout(o.id),o.id=setTimeout(function(){o.id=null,n(e)},500)})}},function(){var t=document.querySelector(".filters"),n=document.querySelector("#filter-recommend"),o=document.querySelector("#filter-popular"),r=document.querySelector("#filter-discussed"),i=document.querySelector("#filter-random"),u=function(){window.data.updatePictures(window.picturesAll)},c=function(){window.data.updatePictures(window.data.sortByLikes(window.picturesAll))},s=function(){window.data.updatePictures(window.data.sortByComments(window.picturesAll))},a=function(){window.data.updatePictures(window.utils.shuffle(window.picturesAll))};window.filters={show:function(){var e=window.debounce.createTimerKeeper();window.debounce.addListener(n,"change",u,e),window.debounce.addListener(o,"change",c,e),window.debounce.addListener(r,"change",s,e),window.debounce.addListener(i,"change",a,e),t.classList.remove("filters-inactive")}}}();
